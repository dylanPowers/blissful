#!/bin/bash

type apt-get &>/dev/null
if [ $? -ne 0 ]; then 
  echo "This system doesn't have the apt package manager. I don't know what to do."
  echo "Maybe you should modify this script to add support for additional package managers???"
  exit
fi

packages_to_install="git ssh apt-transport-https"
sudo apt-get update && sudo apt-get install $packages_to_install


if ! type dart &>/dev/null; then
  # Curtesy of https://www.dartlang.org/install/linux
  sudo sh -c 'curl https://dl-ssl.google.com/linux/linux_signing_key.pub | apt-key add -'
  sudo sh -c 'curl \
    https://storage.googleapis.com/download.dartlang.org/linux/debian/dart_stable.list \
    > \
    /etc/apt/sources.list.d/dart_stable.list'

  sudo apt-get update && sudo apt-get install dart
fi

pub global activate --source path .

echo
if [ ! -f ~/.ssh/id_rsa.pub ]; then
  echo "Hmmmm, no ssh keys. We'll make one then"
  echo
  ssh-keygen -t rsa
fi

echo "********************************************************************"
echo "Make sure the following ssh key is available to your github account:"
cat ~/.ssh/id_rsa.pub

github_user=''
repo_name=".bliss"
install_dir=''
request_github_info() {
  echo
  read -p "Enter your github username [$github_user]: " github_user

  read -p "Repo name [$repo_name]: " repo_name_in
  if [[ ! -z repo_name_in ]]; then repo_name="$repo_name_in"; fi

  install_dir="$repo_name"
  read -p "Install dir [$install_dir]: " install_dir_in
  if [[ ! -z install_dir_in ]]; then install_dir="$install_dir_in"; fi

  github_url="git@github.com:$github_user/$repo_name.git"
  echo
}

continue='n'
while [[ $continue != 'y' ]]; do
  request_github_info
  read -p "Clone $github_url into $install_dir? (y/n): " continue
done

if [ ! -d $install_dir ]; then
  mkdir $install_dir
fi

cd $install_dir

if [ ! -d .git ]; then
  git clone $github_url ./
else
  git pull
fi

instant-bliss --interactive
